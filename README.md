README                        {#mainpage}
======

Welcome to msckf/Hybrid Filter.

The msckf has been fully implemented with the so-called first estimate Jacobian technique.
The Hybrid filter referring to a hybrid of MSCKF and EKF-SLAM is not yet fully implemented.

This is the Jianzhu Huai's implementation of the [1] and [2] with detailed derivation in [3]. It is developed based on the OKVIS library.

[1] Li, M., Yu, H., Zheng, X., & Mourikis, A. I. (2014, May). High-fidelity sensor modeling and self-calibration in vision-aided inertial navigation. In 2014 IEEE International Conference on Robotics and Automation (ICRA) (pp. 409-416). IEEE.

[2] Li, M., & Mourikis, A. I. (2013, July). Optimization-based estimator design for vision-aided inertial navigation. In Proc. of the Robotics: Science and Systems Conference (pp. 241-248).

[3] Michael Andrew Shelley. Monocular Visual Inertial Odometry on a Mobile Device. Master thesis, Technical University of Munich, 2014.

Note that the codebase that you are provided here is free of charge and without 
any warranty. This is bleeding edge research software.

Also note that the quaternion standard has been adapted to match Eigen/ROS, 
thus some related mathematical description in [1,2] will not match the 
implementation here.

If you publish work that relates to this software, please cite at least [1].

## How do I get set up?

This is a catkin package that wraps the pure CMake project.

You will need to install the following dependencies,

* ROS (currently supported: hydro, indigo and jade). Read the instructions in 
  http://wiki.ros.org/indigo/Installation/Ubuntu. You will need the additional 
  package pcl-ros as (assuming indigo)

        sudo apt-get install ros-indigo-pcl-ros

* google-glog + gflags,

        sudo apt-get install libgoogle-glog-dev
   
* The following should get installed through ROS anyway:

        sudo apt-get install libatlas-base-dev libeigen3-dev libsuitesparse-dev 
        sudo apt-get install libopencv-dev libboost-dev libboost-filesystem-dev

then clone the repository from github into your catkin workspace:

    git clone --recursive https://github.com/JzHuai0108/msckf.git

Also vio_common
```
cd workspace/src
git clone https://github.com/JzHuai0108/vio_common.git
# then open CMakeLists.txt of vio_common, on line 9, SET(USE_ROS True)
```

## Building the project

If you have installed okvis_ros in the catkin workspace, then you may need to disable that package by renaming its package.xml file in order to avoid confusing catkin.

From the catkin workspace root, type 
```
cd workspace/
catkin_make -DUSE_ROS=ON -DBUILD_TESTS=ON --pkg vio_common msckf
```
You will find a demo application in devel/lib/msckf/msckf_node. It can process datasets in the ASL/ETH format.

### Configure linter

If you are going to contribute to the project, please configure linter as follows.
The below instructions were tested on Ubuntu 16.04.
```
sudo pip2 install yapf requests
sudo apt install clang-format-6.0 pylint
# the below follows installation guide at https://github.com/ethz-asl/linter/tree/master
cd workspace/src/msckf/tools/linter
echo ". $(realpath setup_linter.sh)" >> ~/.bashrc
bash

cd ../..
init_linter_git_hooks
```
### Run gtests

Both gtest and gmock are required.
```
sudo apt-get install libgtest-dev google-mock
cd /usr/src/gtest
sudo cmake CMakeLists.txt
sudo make
# copy or symlink libgtest.a and libgtest_main.a to your /usr/lib folder
sudo cp *.a /usr/lib

cd /usr/src/gmock
sudo cmake CMakeLists.txt
sudo make
# copy or symlink libgmock.a and libgmock_main.a to your /usr/lib folder
sudo cp *.a /usr/lib
```
Ref: https://www.eriksmistad.no/getting-started-with-google-test-on-ubuntu/

To run all tests,
```
# catkin_make run_tests
rosrun msckf msckf_test
```

To run a selected tests
```
rosrun msckf msckf_test --gtest_filter="*Eigen*"

```

## Debug the project with QtCreator

Follow the below steps exactly, otherwise mysterious errors like missing generate_config file.

Even following the below instructions, the qtcreator still will create binaries and
file structures different from that generated by running catkin_make.

### Build msckf with catkin_make

To prepare the workspace file structure, 
clean build and devel dirs under the workspace, 
then build the project
```
cd msckf_ws/devel
rm -rf ./*
cd ../build
rm -rf ./*
catkin_make -DUSE_ROS=ON --pkg vio_common msckf
```

### Build msckf with QtCreator

To begin with, open qtcreator, suppose msckf_ws is the workspace dir,

```
source msckf_ws/devel/setup.zsh
/opt/Qt/Tools/QtCreator/bin/qtcreator
```

if you encounter the error in starting qtcreator 
"qt.qpa.plugin: Could not load the Qt platform plugin "xcb" in "" even though it was found.",
open another terminal, try the below alternative approach.

```
source /opt/ros/kinetic/setup.zsh
/opt/Qt/Tools/QtCreator/bin/qtcreator
```

Then, open msckf_ws/src/msckf/CMakeLists.txt in QtCreator,
uncomment SET(CATKIN_DEVEL_PREFIX /persist/msckf_ws/devel) in CMakeLists.txt

For the first time, configure the DEFAULT output path for the project in QtCreator as msckf_ws/build/msckf. 
QtCreator may not find cmake files for libraries like roscpp, 
set the path like /opt/ros/kinetic/share/roscpp/cmake. Doing similar changes for other not found ros libraries.

To enable debug mode, in the Build option panel, set CMake Build Type to Debug

To start debugging, add commandline arguments in the Run option panel, then press the Run icon

Example running cases

### Reading measurements from a video and an IMU csv file
```
msckf_ws/devel/lib/msckf/msckf_node $HOME/docker_documents/msckf_ws/src/msckf/config/config_parkinglot_jisun_s6.yaml \
  --output_dir=/media/$USER/Seagate/temp/parkinglot/ --use_AIDP=true \
  --video_file="/media/$USER/Seagate/data/west_campus_parking_lot/Jisun/20151111_120342.mp4" \
  --imu_file="/media/$USER/Seagate/data/west_campus_parking_lot/Jisun/mystream_11_11_12_3_13.csv" \
  --start_index=18800 \
  --finish_index=28900 \
  --max_inc_tol=10.0 \
  --dump_output_option=0 \
  --feature_tracking_method=0 \
  --backend_solver=1

# 16500, 22500
```
The running program will exit once the sequence finishes.

### Measurements from rostopics

1. Download a dataset of your choice from 
   http://projects.asl.ethz.ch/datasets/doku.php?id=kmavvisualinertialdatasets. 
   Assuming you downloaded MH_01_easy/. 
   You will find a corresponding calibration / estimator configuration in the 
   okvis/config folder.

2. Run the node

```
rosrun msckf okvis_node $HOME/docker_documents/msckf_ws/src/msckf/config/config_fpga_p2_euroc_dissertation.yaml --dump_output_option=0 --load_input_option=0 \
  --output_dir=$HOME/Desktop/temp  --use_AIDP=true
# use start to skip the static segment
rosbag play --pause --start=45.0 --rate=1.0 /media/$USER/Seagate/data/euroc/MH_01_easy.bag /cam0/image_raw:=/camera0 /imu0:=/imu

rosrun rviz rviz -d $HOME/docker_documents/msckf_ws/src/msckf/config/rviz.rviz
```
In this case, the program will exit once the Ctrl+C is entered in the terminal that runs the msckf_node. Note the program will not exit if Ctrl+C is entered in the terminal of roscore.

Use the rviz.rviz configuration in the okvis_ros/config/ directory to get the pose / 
landmark display.

## Outputs and frames

In terms of coordinate frames and notation, 

* W denotes the OKVIS World frame (z up), 
* C\_i denotes the i-th camera frame, 
* S denotes the IMU sensor frame,
* B denotes a (user-specified) body frame.

The output of the okvis library is the pose T\_WS as a position r\_WS and quaternion 
q\_WS, followed by the velocity in World frame v\_W and gyro biases (b_g) as well as 
accelerometer biases (b_a). See the example application to get an idea on how to
use the estimator and its outputs (callbacks returning states).

The okvis_node ROS application will publish a configurable state -- see just below.

## Configuration files

The okvis/config folder contains example configuration files. Please read the
documentation of the individual parameters in the yaml file carefully. 
You have various options to trade-off accuracy and computational expense as well 
as to enable online calibration. You also have various options concerning the
things that will get published -- in particular weather or not landmarks should
be published (may be important to turn off for on-bard operation). Moreover, you 
can specify how the body frame is specified (T_BS) or define a custom World frame.
In other words, the final pose published will be 
T\_Wc\_B = T\_Wc\_W * T\_WS * T\_BS^(-1) . You have the option to express the
velocity as well as the rotation rates in either B, S, or Wc. 

## HEALTH WARNING: calibration

If you would like to run the software/library on your own hardware setup, be 
aware that good results (or results at all) may only be obtained with 
appropriate calibration of the 

* camera intrinsics,
* camera extrinsics (poses relative to the IMU), 
* knowledge about the IMU noise parameters,
* and ACCURATE TIME SYNCHRONISATION OF ALL SENSORS.

To perform a calibration yourself, we recommend the following:

* Get Kalibr by following the instructions here 
  https://github.com/ethz-asl/kalibr/wiki/installation . If you decide to build from 
	source and you run ROS indigo checkout pull request 3:

    git fetch origin pull/3/head:request3
    git checkout request3

* Follow https://github.com/ethz-asl/kalibr/wiki/multiple-camera-calibration to 
  calibrate intrinsic and extrinsic parameters of the cameras. If you receive an 
  error message that the tool was unable to make an initial guess on focal 
  length, make sure that your recorded dataset contains frames that have the 
  whole calibration target in view.

* Follow https://github.com/ethz-asl/kalibr/wiki/camera-imu-calibration to get 
  estimates for the spatial parameters of the cameras with respect to the IMU.

* msckf/Hybrid filter does not support pure rotation, and cannot start from static mode, because it uses delayed triangulation. But it supports infinity points.

## Contribution guidelines

* Contact s.leutenegger@imperial.ac.uk to request access to the bitbucket 
  repository.

* Programming guidelines: please follow 
  https://github.com/ethz-asl/programming_guidelines/wiki/Cpp-Coding-Style-Guidelines .
	
* Writing tests: please write unit tests (gtest).

* Code review: please create a pull request for all changes proposed. The pull 
  request will be reviewed by an admin before merging.

## Support

The developpers will be happy to assist you or to consider bug reports / feature 
requests. But questions that can be answered reading this document will be 
ignored. Please contact s.leutenegger@imperial.ac.uk.
